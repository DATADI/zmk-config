/*
 * Copyright (c) 2020 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/pointing.h>

/ {
    /* ==============================================
     * 1. ç¡¬ä»¶å¼•è„šçº¦å®š (ä¿æŒä¸å˜)
     * ============================================== */
    mid_encoder: mid_encoder { 
        compatible = "alps,ec11";
        status = "okay";
        a-gpios = <&gpio0 31 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&gpio0 29 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        steps = <80>;
    };

    sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&mid_encoder>;
        triggers-per-rotation = <20>;
    };

    kscan0: kscan_0 {
        compatible = "zmk,kscan-gpio-direct";
        input-gpios = <&gpio0 20 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
    };

    chosen {
        zmk,kscan = &kscan0;
    };

    /* ==============================================
     * 2. é€»è¾‘è¡Œä¸ºå®šä¹‰ (Behaviors)
     * ============================================== */
    behaviors {
        /* * ğŸŸ¢ æ–°å¢ï¼šè‡ªå®šä¹‰æ»šè½®è¡Œä¸º 
         * é¡ºæ—¶é’ˆ -> SCRL_DOWN (å‘ä¸‹æ»š)
         * é€†æ—¶é’ˆ -> SCRL_UP   (å‘ä¸Šæ»š)
         */
        scroll_encoder: scroll_encoder {
            compatible = "zmk,behavior-sensor-rotate";
            #sensor-binding-cells = <0>;
            /* è¿™é‡Œç›´æ¥å†™æ­»ï¼šé¡ºæ—¶é’ˆæ‰§è¡Œä»€ä¹ˆï¼Œé€†æ—¶é’ˆæ‰§è¡Œä»€ä¹ˆ */
            bindings = <&msc SCRL_DOWN>, <&msc SCRL_UP>;
            /* æ¯æ¬¡è§¦å‘çš„é—´éš” (æ¯«ç§’)ï¼Œå¤ªå¿«äº†å¯ä»¥æ”¹å¤§ï¼Œæ¯”å¦‚ 30 */
            tap-ms = <20>; 
        };

        /* 5è¿å‡»é‡ç½®è“ç‰™ (ä¿æŒä¸å˜) */
        td_5tap: tap_dance_5_times {
            compatible = "zmk,behavior-tap-dance";
            #binding-cells = <0>;
            tapping-term-ms = <300>;
            bindings = <&kp C_PP>, <&none>, <&none>, <&none>, <&bt BT_CLR>;
        };
    };

    /* ==============================================
     * 3. æŒ‰é”®æ˜ å°„å±‚ (Keymap)
     * ============================================== */
    keymap {
        compatible = "zmk,keymap";

        default_layer {
            bindings = < &td_5tap >;
            
            /* * âš ï¸ è¿™é‡Œä¸å†ç”¨ inc_dec_mscï¼Œè€Œæ˜¯ç”¨æˆ‘ä»¬ä¸Šé¢è‡ªå®šä¹‰çš„ &scroll_encoder 
             * å› ä¸ºå·²ç»åœ¨ definition é‡Œå†™æ­»äº†æ–¹å‘ï¼Œè¿™é‡Œä¸éœ€è¦å‚æ•°
             */
            sensor-bindings = <&scroll_encoder>;
        };
    };
};
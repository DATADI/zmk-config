/*
 * Copyright (c) 2020 The ZMK Contributors
 * SPDX-License-Identifier: MIT
 */

#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
/* å¿…é¡»å¼•å…¥é¼ æ ‡å’ŒæŒ‡å‘è®¾å¤‡çš„å¤´æ–‡ä»¶ */
#include <dt-bindings/zmk/pointing.h>

/ {
    /* ==============================================
     * 1. ç¡¬ä»¶å¼•è„šçº¦å®š (ä¸è¦åŠ¨)
     * ============================================== */
    mid_encoder: mid_encoder { 
        compatible = "alps,ec11";
        status = "okay";
        a-gpios = <&gpio0 31 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&gpio0 29 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        /* * steps = <80>; 
         * è¿™é‡Œå¯ä»¥è°ƒæ•´çµæ•åº¦ï¼Œå¦‚æœè§‰å¾—æ»šå¾—å¤ªæ…¢ï¼Œå¯ä»¥æ”¹æˆ 40 æˆ– 20 
         */
        steps = <80>;
    };

    sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&mid_encoder>;
        triggers-per-rotation = <20>;
    };

    kscan0: kscan_0 {
        compatible = "zmk,kscan-gpio-direct";
        input-gpios = <&gpio0 20 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
    };

    chosen {
        zmk,kscan = &kscan0;
    };

    /* ==============================================
     * 2. è¡Œä¸ºå®šä¹‰ (Behaviors)
     * ============================================== */
    behaviors {
        /* * ğŸŸ¢ è‡ªå®šä¹‰æ»šè½®è¡Œä¸º (Scroll Encoder)
         * é€»è¾‘: æ—‹è½¬æ—¶è§¦å‘é¼ æ ‡æ»šè½®äº‹ä»¶
         */
        scroll_encoder: scroll_encoder {
            compatible = "zmk,behavior-sensor-rotate";
            #sensor-binding-cells = <0>;
            
            /* * å…³é”®é…ç½®:
             * ç¬¬ 1 ä¸ªå‚æ•° (é¡ºæ—¶é’ˆ) -> &msc SCRL_DOWN (å‘ä¸‹æ»š)
             * ç¬¬ 2 ä¸ªå‚æ•° (é€†æ—¶é’ˆ) -> &msc SCRL_UP   (å‘ä¸Šæ»š)
             */
            bindings = <&msc SCRL_DOWN>, <&msc SCRL_UP>;
            
            /* è¿å‡»é—´éš” (æ¯«ç§’) - é˜²æ­¢æ»šå¤ªå¿«å¡é¡¿ */
            tap-ms = <30>; 
        };

        /* 5è¿å‡»é‡ç½®è“ç‰™ */
        td_5tap: tap_dance_5_times {
            compatible = "zmk,behavior-tap-dance";
            #binding-cells = <0>;
            tapping-term-ms = <300>;
            bindings = <&kp C_PP>, <&none>, <&none>, <&none>, <&bt BT_CLR>;
        };
    };

    /* ==============================================
     * 3. æŒ‰é”®æ˜ å°„å±‚
     * ============================================== */
    keymap {
        compatible = "zmk,keymap";

        default_layer {
            /* æŒ‰é”®åŠŸèƒ½ï¼šå•å‡»æ’­æ”¾/æš‚åœï¼Œäº”è¿å‡»é‡ç½® */
            bindings = < &td_5tap >;
            
            /* * æ—‹é’®åŠŸèƒ½ï¼šç»‘å®šæˆ‘ä»¬åˆšæ‰å®šä¹‰çš„ scroll_encoder
             * ä¸éœ€è¦ä¼ å‚æ•°ï¼Œå› ä¸ºå·²ç»åœ¨ behaviors é‡Œå†™æ­»äº†
             */
            sensor-bindings = <&scroll_encoder>;
        };
    };
};